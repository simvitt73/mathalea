{"version":3,"file":"_ExternalApp-kb_SfNB0.js","sources":["../../src/exercices/apps/_ExternalApp.ts"],"sourcesContent":["import { get } from 'svelte/store'\nimport { sendToCapytaleSaveStudentAssignment } from '../../lib/handleCapytale'\nimport {\n  exercicesParams,\n  resultsByExercice,\n} from '../../lib/stores/generalStore'\nimport { globalOptions } from '../../lib/stores/globalOptions'\nimport Exercice from '../Exercice'\n\nclass ExternalApp extends Exercice {\n  typeExercice: string\n  container: HTMLDivElement\n  iframe: HTMLIFrameElement\n  url: URL\n  state: 'done' | ''\n  type = 'app'\n  constructor(url: string) {\n    super()\n    this.url = new URL(url)\n\n    this.typeExercice = 'html'\n    this.state = ''\n    this.container = document.createElement('div')\n    this.iframe = document.createElement('iframe')\n    this.iframe.setAttribute('width', '400px')\n    this.iframe.setAttribute('height', '300px')\n    this.iframe.classList.add('my-10')\n    this.iframe.setAttribute('allowfullscreen', '')\n    this.container.appendChild(this.iframe)\n    const updateIframeSize = () => {\n      if (window.innerWidth > window.innerHeight) {\n        this.iframe.setAttribute('width', '100%')\n        this.iframe.setAttribute(\n          'height',\n          (document.body.offsetWidth * 0.75).toString(),\n        )\n      } else {\n        this.iframe.setAttribute('width', '100%')\n        this.iframe.setAttribute(\n          'height',\n          (document.body.offsetWidth * 1.5).toString(),\n        )\n      }\n    }\n    window.addEventListener('resize', updateIframeSize)\n    window.addEventListener('orientationchange', updateIframeSize)\n    this.container.addEventListener('addedToDom', updateIframeSize)\n    window.addEventListener('message', (event) => {\n      if (\n        event.data?.type === 'mathaleaSettings' &&\n        event.data?.numeroExercice === this.numeroExercice\n      ) {\n        this.sup = event.data.urlParams\n        exercicesParams.update((l) => {\n          if (\n            this.numeroExercice !== undefined &&\n            l[this.numeroExercice] !== undefined\n          ) {\n            l[this.numeroExercice].sup = event.data.urlParams\n          }\n          return l\n        })\n      }\n      if (\n        event.data?.type === 'height' &&\n        event.data?.numeroExercice === this.numeroExercice\n      ) {\n        this.iframe.setAttribute('scrolling', 'no')\n        this.iframe.setAttribute('height', event.data.height + 20)\n      }\n    })\n  }\n\n  get html() {\n    exercicesParams.update((l) => {\n      if (\n        this.numeroExercice !== undefined &&\n        l[this.numeroExercice] !== undefined\n      ) {\n        l[this.numeroExercice].type = 'app'\n      }\n      return l\n    })\n    this.handleScore()\n    if (this.sup !== undefined) {\n      const searchParams = new URLSearchParams(this.sup)\n      for (const [key, value] of searchParams.entries()) {\n        this.url.searchParams.set(key, value)\n      }\n    }\n    if (get(globalOptions).v === 'eleve') {\n      this.url.searchParams.set('v', 'eleve')\n    }\n    if (this.numeroExercice !== undefined) {\n      this.url.searchParams.set(\n        'numeroExercice',\n        this.numeroExercice.toString(),\n      )\n    }\n    this.url.searchParams.set('seed', this.seed ?? '')\n    this.iframe.setAttribute('src', this.url.toString())\n    return this.container\n  }\n\n  handleScore() {\n    window.addEventListener('message', (event) => {\n      if (event.data?.numeroExercice !== this.numeroExercice) return\n      if (event.data?.type === 'mathaleaSendScore') {\n        this.state = 'done'\n        const numberOfPoints = parseInt(event.data.score)\n        const indice = parseInt(event.data.numeroExercice)\n        const numberOfQuestions = parseInt(event.data.numberOfQuestions)\n        const answers = Array.isArray(event.data.finalState)\n          ? event.data.finalState\n          : [event.data.finalState]\n        const type = 'app'\n        const results = get(resultsByExercice)\n        let bestScore = results[indice]?.numberOfPoints || 0\n        if (numberOfPoints > bestScore) {\n          bestScore = numberOfPoints\n        }\n        resultsByExercice.update((l) => {\n          l[indice] = {\n            numberOfPoints,\n            bestScore,\n            numberOfQuestions,\n            indice,\n            answers,\n            type,\n          }\n          return l\n        })\n        if (get(globalOptions).recorder === 'capytale') {\n          sendToCapytaleSaveStudentAssignment({\n            indiceExercice: this.numeroExercice,\n          })\n        }\n      } else if (event.data?.type === 'mathaleaHasScore') {\n        const numberOfPoints = parseInt(event.data.score)\n        const indice = parseInt(event.data.numeroExercice)\n        const numberOfQuestions = parseInt(event.data.numberOfQuestions)\n        const answers = Array.isArray(event.data.finalState)\n          ? event.data.finalState\n          : [event.data.finalState]\n        resultsByExercice.update((l) => {\n          l[indice] = { numberOfPoints, numberOfQuestions, indice, answers }\n          return l\n        })\n        const message = {\n          type: 'mathaleaHasScore',\n          score: numberOfPoints,\n          numeroExercice: indice,\n          numberOfQuestions,\n          finalState: answers,\n        }\n        if (this.iframe !== null && this.iframe.contentWindow !== null) {\n          this.iframe.contentWindow.postMessage(message, '*')\n        }\n      } else if (event.data?.type === 'mathaleaAskScore') {\n        const indice = parseInt(event.data.numeroExercice) || 0\n        const results = get(resultsByExercice)[indice]\n        if (typeof results !== 'undefined') {\n          const message = {\n            type: 'mathaleaHasScore',\n            score: results.numberOfPoints,\n            numeroExercice: indice,\n            numberOfQuestions: results.numberOfQuestions,\n            finalState: results.answers,\n          }\n          if (this.iframe !== null && this.iframe.contentWindow !== null) {\n            this.iframe.contentWindow.postMessage(message, '*')\n          }\n        }\n      }\n    })\n  }\n}\n\nexport default ExternalApp\n"],"names":["ExternalApp","Exercice","url","__publicField","updateIframeSize","event","_a","_b","exercicesParams","l","_c","_d","searchParams","key","value","get","globalOptions","numberOfPoints","indice","numberOfQuestions","answers","type","bestScore","resultsByExercice","sendToCapytaleSaveStudentAssignment","message","_e","results"],"mappings":"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"}