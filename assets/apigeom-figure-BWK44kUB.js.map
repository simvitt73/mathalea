{"version":3,"file":"apigeom-figure-BWK44kUB.js","sources":["../../src/lib/apigeom/setupFractionFigure.ts","../../src/lib/apigeom/apigeom-figure.ts"],"sourcesContent":["import erase from 'apigeom/src/assets/svg/erase.svg'\nimport minus from 'apigeom/src/assets/svg/minus.svg'\nimport plus from 'apigeom/src/assets/svg/plus.svg'\nimport RectangleFractionDiagram from 'apigeom/src/elements/diagrams/RectangleFractionDiagram'\nimport TextByPosition from 'apigeom/src/elements/text/TextByPosition'\nimport type Figure from 'apigeom/src/Figure'\n\nexport function setupFractionFigureIfNeeded(figure: Figure): void {\n  if (\n    !Array.from(figure.elements.values()).some(\n      (ele) => ele instanceof RectangleFractionDiagram,\n    )\n  ) {\n    return // ‚ùå Rien √† injecter\n  }\n\n  // üî• √Ä partir d‚Äôici on sait que la figure est compatible\n  function decreaseDenominator(): void {\n    let denominator = 2\n    figure.elements.forEach((ele) => {\n      if (ele instanceof RectangleFractionDiagram) {\n        if (ele.denominator === 2) return\n        const num = ele.numerator\n        ele.denominator--\n        denominator = ele.denominator\n        ele.redraw()\n        ele.numerator = num\n      }\n      if (ele instanceof TextByPosition) {\n        ele.text = `L'unit√© est partag√©e en ${denominator} parts √©gales.`\n      }\n    })\n  }\n\n  function increaseDenominator(): void {\n    let denominator = 2\n    figure.elements.forEach((ele) => {\n      if (ele instanceof RectangleFractionDiagram) {\n        const num = ele.numerator\n        ele.denominator++\n        denominator = ele.denominator\n        ele.redraw()\n        ele.numerator = num\n      }\n      if (ele instanceof TextByPosition) {\n        ele.text = `L'unit√© est partag√©e en ${denominator} parts √©gales.`\n      }\n    })\n  }\n\n  function clearFill(): void {\n    figure.elements.forEach((ele) => {\n      if (ele instanceof RectangleFractionDiagram) {\n        ele.numerator = 0\n      }\n    })\n  }\n\n  // Toolbar\n  figure.setToolbar({ position: 'top', tools: ['FILL'] })\n\n  // Label\n  const p = document.createElement('p')\n  p.textContent = 'Brouillon non √©valu√©'\n  p.classList.add(\n    'italic',\n    'font-black',\n    'text-coopmaths-struct',\n    'ml-10',\n    'my-auto',\n  )\n\n  figure.addCustomButton({\n    action: decreaseDenominator,\n    tooltip: 'Diminuer le nombre de parts',\n    url: minus,\n  })\n\n  figure.addCustomButton({\n    action: increaseDenominator,\n    record: true,\n    tooltip: 'Augmenter le nombre de parts',\n    url: plus,\n  })\n\n  figure.addCustomButton({\n    action: clearFill,\n    tooltip: 'R√©initialiser le coloriage',\n    url: erase,\n  })\n\n  figure.divButtons.appendChild(p)\n  figure.container.classList.add(\n    'border-2',\n    'border-coopmaths-struct',\n    'p-2',\n    'rounded-md',\n  )\n\n  figure.container.style.overflowX = 'auto'\n  figure.divUserMessage.style.display = 'none'\n\n  // Texte initial seulement s‚Äôil n‚Äôexiste pas d√©j√†\n  const hasText = Array.from(figure.elements.values()).some(\n    (ele: any) => ele instanceof TextByPosition,\n  )\n\n  if (!hasText) {\n    figure.create('TextByPosition', {\n      text: `L'unit√© est partag√©e en 2 parts √©gales.`,\n      x: 0,\n      y: -1.5,\n      anchor: 'bottomLeft',\n      isChild: false,\n    })\n  }\n}\n","import Figure from 'apigeom'\nimport { get } from 'svelte/store'\nimport { canOptions } from '../../../src/lib/stores/canStore'\nimport { globalOptions } from '../../../src/lib/stores/globalOptions'\nimport { context } from '../../../src/modules/context'\nimport { setupFractionFigureIfNeeded } from './setupFractionFigure'\n\nexport class ApigeomFigureElement extends HTMLElement {\n  static autoIndex = 0\n\n  static get observedAttributes() {\n    return [\n      'figure-json',\n      'numero-exercice',\n      'auto-index',\n      'index',\n      'x-min',\n      'y-min',\n      'width',\n      'height',\n      'animation',\n      'default-action',\n      'interactive',\n      'has-feedback',\n      'id-addendum',\n    ]\n  }\n\n  private figure?: Figure\n  private destroyed = false\n  private oldZoom = 1\n  private idApigeom!: string\n\n  private resolveIndex(): string {\n    const attr = this.hasAttribute('auto-index')\n    if (attr) {\n      return 'A' + ApigeomFigureElement.autoIndex++\n    }\n    return ''\n  }\n\n  /* ==============================\n     Lifecycle\n  ============================== */\n\n  connectedCallback() {\n    if (!context.isHtml) return\n    this.render()\n    this.createFigure()\n    this.bindEvents()\n  }\n\n  disconnectedCallback() {\n    this.destroy()\n  }\n\n  attributeChangedCallback(\n    name: string,\n    oldValue: string | null,\n    newValue: string | null,\n  ) {\n    // if (!this.isConnected) return\n    // console.log(`Attribute ${name} changed from ${oldValue} to ${newValue}`)\n  }\n\n  /* ==============================\n     Rendering\n     ============================== */\n\n  private render() {\n    const index = Number(this.getAttribute('index') ?? 0)\n    const numeroExercice = Number(this.getAttribute('numero-exercice') ?? 0)\n    const hasFeedback = this.hasAttribute('has-feedback')\n    const autoIndex = this.resolveIndex()\n\n    this.idApigeom = `apigeomEx${numeroExercice}F${index}${this.getAttribute('id-addendum') ?? ''}${autoIndex}`\n\n    this.figure = new Figure({\n      xMin: Number(this.getAttribute('x-min') ?? 0),\n      yMin: Number(this.getAttribute('y-min') ?? 0),\n      width: Number(this.getAttribute('width') ?? 400),\n      height: Number(this.getAttribute('height') ?? 400),\n    })\n\n    const script = this.querySelector('script[type=\"application/json\"]')\n    if (!script) return\n\n    const jsonText = script.textContent?.trim()\n    if (!jsonText) return\n    this.figure.loadJson(JSON.parse(jsonText))\n\n    setupFractionFigureIfNeeded(this.figure)\n\n    this.innerHTML = `\n      <script type=\"application/json\">${jsonText}</script>\n      <div class=\"m-6 leading-none\" id=\"${this.idApigeom}\"></div>\n      ${\n        hasFeedback && !autoIndex\n          ? `\n        <span id=\"resultatCheckEx${numeroExercice}Q${index}\"></span>\n        <div class=\"ml-2 py-2 text-coopmaths-warn-darkest dark:text-coopmathsdark-warn-darkest\"\n             id=\"feedbackEx${numeroExercice}Q${index}\"></div>`\n          : ''\n      }\n    `\n  }\n\n  /* ==============================\n     Figure creation\n     ============================== */\n\n  private createFigure() {\n    if (this.figure === undefined) return\n\n    const interactive = this.hasAttribute('interactive')\n    this.figure.isDynamic = interactive\n    this.figure.divButtons.style.display = interactive ? 'grid' : 'none'\n\n    const container = this.querySelector(`#${this.idApigeom}`) as HTMLDivElement\n    if (!container) return\n\n    this.figure.setContainer(container)\n\n    const defaultAction = this.getAttribute('default-action')\n    if (defaultAction) {\n      this.figure.buttons.get(defaultAction)?.click()\n    }\n\n    this.applyZoom()\n  }\n\n  /* ==============================\n     Events\n     ============================== */\n\n  private onReload = (event: Event) => {\n    if (!this.figure?.options) return\n    const json = (event as CustomEvent).detail\n    this.figure.loadJson(JSON.parse(json))\n\n    if (get(canOptions).isChoosen && get(canOptions).state === 'solutions') {\n      this.figure.divButtons.style.display = 'none'\n      this.figure.divUserMessage.style.display = 'none'\n    }\n  }\n\n  private onReloadBound = this.onReload.bind(this)\n\n  private onZoom = (event: Event) => {\n    console.log('zoomChanged event received')\n    if (!this.figure?.options) return\n    const zoom = Number((event as CustomEvent).detail.zoom)\n    if (zoom !== this.oldZoom) {\n      this.oldZoom = zoom\n      this.figure.zoom(zoom, {\n        changeHeight: true,\n        changeWidth: true,\n        changeLeft: false,\n        changeBottom: false,\n      })\n    }\n  }\n\n  private onZoomBound = this.onZoom.bind(this)\n\n  private applyZoom() {\n    const zoom = Number(get(globalOptions).z)\n    if (zoom !== this.oldZoom && this.figure) {\n      this.oldZoom = zoom\n      this.figure.zoom(zoom, {\n        changeHeight: true,\n        changeWidth: true,\n        changeLeft: false,\n        changeBottom: false,\n      })\n    }\n  }\n\n  private boundApplyZoom = this.applyZoom.bind(this)\n\n  private bindEvents() {\n    document.addEventListener(this.idApigeom, this.onReloadBound)\n    document.addEventListener('zoomChanged', this.onZoomBound)\n    document.addEventListener('exercicesAffiches', this.boundApplyZoom)\n  }\n\n  /* ==============================\n     Cleanup\n     ============================== */\n\n  private destroy() {\n    if (this.destroyed) return\n    this.destroyed = true\n\n    document.removeEventListener(this.idApigeom, this.onReloadBound)\n    document.removeEventListener('zoomChanged', this.onZoomBound)\n    document.removeEventListener('exercicesAffiches', this.boundApplyZoom)\n\n    this.figure?.destroy?.()\n    this.figure = undefined\n  }\n}\n\nexport default function handleApigeomFigureElement() {\n  if (!customElements.get('apigeom-figure')) {\n    customElements.define('apigeom-figure', ApigeomFigureElement)\n  }\n}\n"],"names":["setupFractionFigureIfNeeded","figure","ele","RectangleFractionDiagram","decreaseDenominator","denominator","num","TextByPosition","increaseDenominator","clearFill","p","minus","plus","erase","_ApigeomFigureElement","__publicField","event","_a","json","get","canOptions","zoom","context","name","oldValue","newValue","index","numeroExercice","hasFeedback","autoIndex","Figure","script","jsonText","interactive","container","defaultAction","globalOptions","_b","ApigeomFigureElement","handleApigeomFigureElement"],"mappings":"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"}