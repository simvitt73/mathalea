{"version":3,"file":"video-BGTD7oqB.js","sources":["../../src/exercices/ressources/video.ts"],"sourcesContent":["import { get } from 'svelte/store'\nimport { updateIframeSize } from '../../lib/components/sizeTools'\nimport { getUniqueStringBasedOnTimeStamp } from '../../lib/components/time'\nimport { exercicesParams } from '../../lib/stores/generalStore'\nimport { globalOptions } from '../../lib/stores/globalOptions'\nimport Exercice from '../Exercice'\nimport { createButon, createIButton, createTextInput } from './_components'\n\nexport const uuid = 'video'\nexport const titre = 'Vidéo'\n\nclass ressourceVideo extends Exercice {\n  container: HTMLDivElement\n  iframe: HTMLIFrameElement\n  fieldUrl: HTMLInputElement\n  fieldText: HTMLInputElement\n  teacherText: HTMLDivElement\n  iTooltip: HTMLButtonElement\n  button: HTMLButtonElement\n  constructor() {\n    super()\n    this.typeExercice = 'html'\n    this.titre = 'Vidéo'\n    this.container = document.createElement('div')\n    this.container.setAttribute('overflow', 'auto')\n    this.iframe = document.createElement('iframe')\n    this.iframe.setAttribute('width', '500')\n    this.iframe.setAttribute('height', '315')\n    this.iframe.setAttribute('title', 'YouTube video player')\n    this.iframe.setAttribute('frameborder', '0')\n    this.iframe.setAttribute(\n      'allow',\n      'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share',\n    )\n    this.iframe.setAttribute('allowfullscreen', '')\n    this.teacherText = document.createElement('div')\n    window.addEventListener('resize', this.updateSize)\n    this.container.addEventListener('addedToDom', this.updateSize)\n    document.addEventListener('questionDisplay', this.updateSize)\n\n    // constitution d'une ID pour mise en forme dans app.css\n    this.iframe.setAttribute(\n      'id',\n      'iframe-video' + getUniqueStringBasedOnTimeStamp('-'),\n    )\n    // /!\\ pas de mise en formee ici !!!\n    // this.iframe.classList.add('my-10')\n    this.fieldUrl = createTextInput({ placeholder: 'URL', autoCorrect: false })\n    this.fieldText = createTextInput({ placeholder: 'Consigne éventuelle' })\n    this.fieldText.style.display = 'block'\n    this.button = createButon()\n    const tooltip = `Formats supportés : \n- lien direct vers la vidéo\n- peertube\n- podeduc.apps.education.fr\n- www.youtube.com\n- youtu.be\n- www.dailymotion.com\n- dai.ly\n- vimeo.com`\n    this.iTooltip = createIButton({ tooltip, direction: 'bottom' })\n    this.container.append(\n      this.fieldUrl,\n      this.iTooltip,\n      this.fieldText,\n      this.teacherText,\n      this.button,\n      this.iframe,\n    )\n    this.button.addEventListener('click', () => {\n      // On transforme https://youtu.be/Jup128waBI8 en https://www.youtube.com/embed/Jup128waBI8\n      this.updateVideoFromUrl()\n      this.sup = encodeURIComponent(this.fieldUrl.value)\n      if (this.fieldText.value !== '') {\n        this.sup2 = encodeURIComponent(this.fieldText.value)\n      }\n      exercicesParams.update((l) => {\n        if (\n          this.numeroExercice !== undefined &&\n          l[this.numeroExercice] !== undefined\n        ) {\n          l[this.numeroExercice].sup = this.sup\n          if (this.fieldText.value !== '') {\n            l[this.numeroExercice].sup2 = encodeURIComponent(\n              this.fieldText.value,\n            )\n          }\n        }\n        return l\n      })\n    })\n  }\n\n  private updateSize = () => {\n    // same function as in video.ts\n    updateIframeSize(this.container, this.iframe)\n  }\n\n  destroy() {\n    window.removeEventListener('resize', this.updateSize)\n    this.container.removeEventListener('addedToDom', this.updateSize)\n  }\n\n  get html() {\n    if (get(globalOptions).v === 'eleve') {\n      this.fieldUrl.remove()\n      this.fieldText.remove()\n      this.button.remove()\n      this.iTooltip.remove()\n    }\n    if (this.sup !== undefined) {\n      try {\n        let iframeUrl: string | URL\n        try {\n          iframeUrl = new URL(decodeURIComponent(this.sup))\n          if (\n            iframeUrl.protocol === 'http:' ||\n            iframeUrl.protocol === 'https:' ||\n            iframeUrl.protocol === 'ftp:'\n          ) {\n            iframeUrl = iframeUrl.href\n          } else {\n            iframeUrl = 'data:text/html,Erreur'\n          }\n        } catch (e) {\n          iframeUrl = 'data:text/html,Erreur'\n        }\n        this.iframe.src = iframeUrl\n        this.fieldUrl.value = iframeUrl\n      } catch (e) {\n        console.error('Invalid URI: ', this.sup)\n      }\n      this.updateVideoFromUrl()\n    }\n    if (this.sup2 !== undefined) {\n      try {\n        this.teacherText.textContent = decodeURIComponent(this.sup2)\n      } catch (e) {\n        console.error('Invalid URI: ', this.sup2)\n      }\n    }\n    return this.container\n  }\n\n  updateVideoFromUrl() {\n    const url = new URL(this.fieldUrl.value)\n    if (url.hostname === 'youtu.be') {\n      url.hostname = 'www.youtube.com'\n      url.pathname = '/embed' + url.pathname\n      this.iframe.src = url.toString()\n    } else if (url.hostname === 'www.youtube.com') {\n      this.iframe.src = url.toString().replace('watch?v=', 'embed/')\n    } else if (url.hostname === 'www.dailymotion.com') {\n      url.pathname = '/embed' + url.pathname\n      this.iframe.src = url.toString()\n    } else if (url.hostname === 'dai.ly') {\n      url.hostname = 'www.dailymotion.com'\n      url.pathname = '/embed/video' + url.pathname\n      this.iframe.src = url.toString()\n    } else if (url.hostname === 'vimeo.com') {\n      url.hostname = 'player.vimeo.com'\n      url.pathname = '/video' + url.pathname\n      this.iframe.src = url.toString()\n    } else if (url.hostname === 'podeduc.apps.education.fr') {\n      this.iframe.src = this.fieldUrl.value + '/?is_iframe=true'\n    } else if (this.fieldUrl.value.includes('/w/')) {\n      // Gestion des url en provenance de peertube\n      this.iframe.src = this.fieldUrl.value.replace('/w/', '/videos/embed/')\n    } else {\n      this.iframe.src = this.fieldUrl.value\n    }\n    this.teacherText.textContent = this.fieldText.value\n    this.titre = this.fieldText.value\n  }\n}\n\nexport default ressourceVideo\n"],"names":["uuid","titre","ressourceVideo","Exercice","__publicField","updateIframeSize","getUniqueStringBasedOnTimeStamp","createTextInput","createButon","tooltip","createIButton","exercicesParams","l","get","globalOptions","iframeUrl","url"],"mappings":"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"}