import{r as M}from"./eventemitter3-COjgItKg.js";var y={},v={},C;function S(){if(C)return v;C=1;var h=v&&v.__extends||(function(){var s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(o,t){o.__proto__=t}||function(o,t){for(var l in t)t.hasOwnProperty(l)&&(o[l]=t[l])};return function(o,t){s(o,t);function l(){this.constructor=o}o.prototype=t===null?Object.create(t):(l.prototype=t.prototype,new l)}})();Object.defineProperty(v,"__esModule",{value:!0});var c=(function(s){h(o,s);function o(t,l,_){var f=s.call(this,"Error #"+t+": "+l)||this;return f.code=t,f.message=l,f.path=_,Object.setPrototypeOf(f,o.prototype),f}return o.prototype.toReplyError=function(){return{code:this.code,message:this.message,path:this.path}},o})(Error);return v.RPCError=c,v}var P={},E;function b(){if(E)return P;E=1,Object.defineProperty(P,"__esModule",{value:!0});var h=(function(){function c(){this.lastSequentialCall=-1,this.queue=[]}return c.prototype.reset=function(s){this.lastSequentialCall=s-1,this.queue=[]},c.prototype.append=function(s){if(s.counter<=this.lastSequentialCall+1){var o=[s];return this.lastSequentialCall=s.counter,this.replayQueue(o),o}for(var t=0;t<this.queue.length;t++)if(this.queue[t].counter>s.counter)return this.queue.splice(t,0,s),[];return this.queue.push(s),[]},c.prototype.replayQueue=function(s){for(;this.queue.length;){var o=this.queue[0];if(o.counter>this.lastSequentialCall+1)return;s.push(this.queue.shift()),this.lastSequentialCall=o.counter}},c})();return P.Reorder=h,P}var m={},O;function j(){if(O)return m;O=1,Object.defineProperty(m,"__esModule",{value:!0});function h(c){return(c.type==="method"||c.type==="reply")&&typeof c.counter=="number"}return m.isRPCMessage=h,m.defaultRecievable={readMessages:function(c){return window.addEventListener("message",c),function(){return window.removeEventListener("message",c)}}},m}var w;function x(){if(w)return y;w=1;var h=y&&y.__extends||(function(){var p=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,e){n.__proto__=e}||function(n,e){for(var r in e)e.hasOwnProperty(r)&&(n[r]=e[r])};return function(n,e){p(n,e);function r(){this.constructor=n}n.prototype=e===null?Object.create(e):(r.prototype=e.prototype,new r)}})();Object.defineProperty(y,"__esModule",{value:!0});var c=M(),s=S(),o=b(),t=j();function l(p){return new s.RPCError(p.code,p.message,p.path)}var _=-1,f=(function(p){h(n,p);function n(e){var r=p.call(this)||this;return r.options=e,r.calls=Object.create(null),r.callCounter=0,r.reorder=new o.Reorder,r.listener=function(a){if(!(r.options.origin&&r.options.origin!=="*"&&a.origin!==r.options.origin)){var i;try{i=JSON.parse(a.data)}catch{return}if(!(!t.isRPCMessage(i)||i.serviceID!==r.options.serviceId)){if(r.isReadySignal(i)){var u=i.type==="method"?i.params:i.result;u&&u.protocolVersion?r.remoteProtocolVersion=u.protocolVersion:r.remoteProtocolVersion=r.remoteProtocolVersion,r.callCounter=0,r.reorder.reset(i.counter),r.emit("isReady",!0)}for(var d=0,R=r.reorder.append(i);d<R.length;d++){var g=R[d];r.emit("recvData",g),r.dispatchIncoming(g)}}}},r.unsubscribeCallback=(e.receiver||t.defaultRecievable).readMessages(r.listener),r.isReady=new Promise(function(a){var i={protocolVersion:e.protocolVersion||"1.0"};r.expose("ready",function(){return a(),i}),r.call("ready",i).then(a).catch(a)}),r}return n.prototype.create=function(e){var r=new n(e);return r.isReady.then(function(){return r})},n.prototype.expose=function(e,r){var a=this;return this.on(e,function(i){if(i.discard){r(i.params);return}new Promise(function(u){return u(r(i.params))}).then(function(u){return{type:"reply",serviceID:a.options.serviceId,id:i.id,result:u}}).catch(function(u){return{type:"reply",serviceID:a.options.serviceId,id:i.id,error:u instanceof s.RPCError?u.toReplyError():{code:0,message:u.stack||u.message}}}).then(function(u){a.emit("sendReply",u),a.post(u)})}),this},n.prototype.call=function(e,r,a){var i=this;a===void 0&&(a=!0);var u=e==="ready"?_:this.callCounter,d={type:"method",serviceID:this.options.serviceId,id:u,params:r,method:e,discard:!a};if(this.emit("sendMethod",d),this.post(d),!!a)return new Promise(function(R,g){i.calls[u]=function(q,I){q?g(q):R(I)}})},n.prototype.destroy=function(){this.emit("destroy"),this.unsubscribeCallback()},n.prototype.remoteVersion=function(){return this.remoteProtocolVersion},n.prototype.handleReply=function(e){var r=this.calls[e.id];r&&(e.error?r(l(e.error),null):r(null,e.result),delete this.calls[e.id])},n.prototype.post=function(e){e.counter=this.callCounter++,this.options.target.postMessage(JSON.stringify(e),this.options.origin||"*")},n.prototype.isReadySignal=function(e){return e.type==="method"&&e.method==="ready"||e.type==="reply"&&e.id===_},n.prototype.dispatchIncoming=function(e){switch(e.type){case"method":if(this.emit("recvMethod",e),this.listeners(e.method).length>0){this.emit(e.method,e);return}this.post({type:"reply",serviceID:this.options.serviceId,id:e.id,error:{code:4003,message:'Unknown method name "'+e.method+'"'},result:null});break;case"reply":this.emit("recvReply",e),this.handleReply(e);break}},n})(c.EventEmitter);return y.RPC=f,y}var D=x();export{D as r};
//# sourceMappingURL=mixer_postmessage-rpc-JyZjM7pP.js.map
