{"version":3,"file":"figureApigeom-7nV49ZkO.js","sources":["../../src/lib/figureApigeom.ts"],"sourcesContent":["import Figure from 'apigeom'\nimport { get } from 'svelte/store'\nimport { canOptions } from '../../src/lib/stores/canStore'\nimport type { IExercice } from '../lib/types'\nimport { context } from '../modules/context'\nimport { exercicesParams } from './stores/generalStore'\nimport { globalOptions } from './stores/globalOptions'\n\nexport function isFigureArray(figs: IExercice['figures']): figs is Figure[] {\n  return Array.isArray(figs) && figs.length > 0 && figs[0] instanceof Figure\n}\n\n/**\n * - Insère une figure apigeom dans la sortie HTML de l'exercice\n *\n * - defaultAction permet de sélectionner le bouton activé par défaut (bouton qui doit être présent dans la toolbar de la figure)\n *\n * - L'id est générée automatiquement avec le numéro de l'exercice et de la question\n *\n * - Si une même question a plusieurs figures, il faut ajouter un idAddendum (par exemple 'Correction' pour la figure de correction)\n */\nexport default function figureApigeom({\n  exercice,\n  figure,\n  animation = false,\n  i,\n  defaultAction,\n  idAddendum = '',\n  isDynamic,\n  hasFeedback = true,\n}: {\n  exercice: IExercice\n  figure: Figure\n  animation?: boolean\n  i: number\n  /** identifiant supplémentaire pour identifier l'\n   * si c'est la figure de la correction ou une 2e figure dans la question\n   */\n  idAddendum?: string\n  /** Action en cours au lancement de l'exercice qui doit obligatoirement être un bouton de la toolbar */\n  defaultAction?: string\n  /** figure chargé en interactif et pourtant on souhaite qu'elle soit statique => isDynamic = false */\n  isDynamic?: boolean\n  /** la figure sera-t-elle évaluée ? */\n  hasFeedback?: boolean\n}): string {\n  if (!context.isHtml) return ''\n  // Styles par défaut\n  figure.isDynamic = isDynamic !== undefined ? isDynamic : !!exercice.interactif\n  figure.divButtons.style.display = figure.isDynamic ? 'grid' : 'none'\n  figure.divUserMessage.style.fontSize = '1em'\n  figure.divUserMessage.style.pointerEvents = 'none'\n  figure.divUserMessage.style.removeProperty('color')\n  figure.divUserMessage.classList.add('text-coopmaths-struct')\n  if (!exercice.interactif) {\n    figure.divUserMessage.style.display = 'none'\n  }\n  const idApigeom = `apigeomEx${exercice.numeroExercice}F${i}${idAddendum}`\n  figure.id = idApigeom\n\n  // Pour revoir la copie de l'élève dans Capytale\n  // Attention, la clé de answers[] doit contenir apigeom, c'est pourquoi l'id est généré par cette fonction\n  function idApigeomFunct(event: Event): void {\n    if (!figure.options) {\n      // figure effacée, donc on annule la mise à jour...\n      destroy()\n      return\n    }\n    const customEvent = event as CustomEvent\n    const json = customEvent.detail\n    figure.loadJson(JSON.parse(json))\n    if (get(canOptions).isChoosen && get(canOptions).state === 'solutions') {\n      // c'est la can et on est en mode solutions\n      figure.divButtons.style.display = 'none'\n      figure.divUserMessage.style.display = 'none'\n    }\n  }\n  document.addEventListener(idApigeom, idApigeomFunct)\n\n  let oldZoom = 1\n  function updateZoom(event: Event): void {\n    if (!figure.options) {\n      // figure effacée, donc on annule la mise à jour...\n      destroy()\n      return\n    }\n    // console.log('ExZoom:' + idApigeom)\n    const customEvent = event as CustomEvent\n    const zoom = Number(customEvent.detail.zoom)\n    if (oldZoom !== zoom) {\n      oldZoom = zoom\n      // console.log('zoom:' + idApigeom + ':' + zoom)\n      if (figure != null)\n        figure.zoom(zoom, {\n          changeHeight: true,\n          changeWidth: true,\n          changeLeft: false,\n          changeBottom: false,\n        })\n    }\n  }\n  document.addEventListener('zoomChanged', updateZoom)\n\n  function updateAffichage(): void {\n    if (!figure.options) {\n      // figure effacée, donc on annule la mise à jour...\n      destroy()\n      return\n    }\n    if (!context.isHtml) {\n      return\n    }\n    const container = document.querySelector(`#${idApigeom}`) as HTMLDivElement\n    // console.log('container:' + figure.id + ':' + container)\n    if (container == null) {\n      return\n    }\n    const eles = document.querySelectorAll(`#${idApigeom}`)\n    if (eles.length > 1) {\n      // MGU on devrait jamais être ici mais ça arrive parfois avec les composants Svelte\n      window.notify(\n        `Plusieurs éléments avec le même id ${idApigeom} dans la page.`,\n        { exercice, figure },\n      )\n    }\n\n    container.innerHTML = ''\n    try {\n      figure.setContainer(container)\n    } catch (e) {\n      window.notify(\n        `figureApigeom: erreur lors du setContainer de la figure ${idApigeom}`,\n        {\n          figure,\n          container,\n          exo: exercice,\n          globalOptions: get(globalOptions),\n          exercicesParams: get(exercicesParams),\n        },\n      )\n      throw e\n    }\n\n    if (animation) {\n      figure.divUserMessage.innerHTML = ''\n      figure.restart()\n      setTimeout(() => {\n        figure.buttons.get('PLAY')?.click()\n      }, 3000)\n    }\n    if (defaultAction) {\n      figure.buttons.get(defaultAction)?.click()\n      // MGu que la première fois\n      defaultAction = ''\n    }\n    const zoom = Number(get(globalOptions).z)\n    if (oldZoom !== zoom) {\n      oldZoom = zoom\n      figure.zoom(zoom, {\n        changeHeight: true,\n        changeWidth: true,\n        changeLeft: false,\n        changeBottom: false,\n      })\n    }\n  }\n  document.addEventListener('exercicesAffiches', updateAffichage)\n\n  // --------------------------\n  // CLEANUP\n  // --------------------------\n\n  let destroyed = false\n  const destroy = () => {\n    if (destroyed) return\n    destroyed = true\n    document.removeEventListener(idApigeom, idApigeomFunct)\n    document.removeEventListener('zoomChanged', updateZoom)\n    document.removeEventListener('exercicesAffiches', updateAffichage)\n  }\n\n  // On surcharge la méthode clearHtml de la figure pour faire le cleanup des listeners\n  const originalDestroy = figure.destroy?.bind(figure)\n\n  figure.destroy = () => {\n    destroy()\n    // Appeler Apigeom original pour purger ce qu’il doit purger\n    if (figure.options && originalDestroy) {\n      originalDestroy()\n    }\n  }\n\n  if (hasFeedback) {\n    return `<div class=\"m-6 leading-none\" id=\"${idApigeom}\"></div><span id=\"resultatCheckEx${exercice.numeroExercice}Q${i}\"></span><div class=\"ml-2 py-2 text-coopmaths-warn-darkest dark:text-coopmathsdark-warn-darkest\" id=\"feedbackEx${exercice.numeroExercice}Q${i}\"></div>`\n  }\n  return `<div class=\"m-6 leading-none\" id=\"${idApigeom}\"></div>`\n}\n"],"names":["isFigureArray","figs","Figure","figureApigeom","exercice","figure","animation","i","defaultAction","idAddendum","isDynamic","hasFeedback","context","idApigeom","idApigeomFunct","event","destroy","json","get","canOptions","oldZoom","updateZoom","zoom","updateAffichage","container","e","globalOptions","exercicesParams","_a","destroyed","originalDestroy"],"mappings":"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"}